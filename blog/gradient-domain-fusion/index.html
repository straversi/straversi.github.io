<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Gradient Domain Fusion • steven.codes</title><meta name="description" content="This post is a modified version of a site that I submitted for a project in my image manipulation class with Alexei Efros."><link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Bitter:400,700" rel="stylesheet"> <!--<link rel="stylesheet" href="/blog/css/main.css"> --><link rel="stylesheet" href="/blog/css/main.css?v=1.3.1"><link rel="canonical" href="http://steven.codes/blog/gradient-domain-fusion/"><link rel="alternate" type="application/rss+xml" title="steven.codes" href="http://steven.codes/blog/feed.xml"><link rel="stylesheet" href="/blog/assets/posts/gradient-domain-fusion/gradient_figures.css " media="screen" type="text/css"></head><body><div class="page-content"><header class="new-header"><div class="wrapper"> <a class="site-title" href="/blog/">steven.codes</a></div></header><div class="wrapper"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Gradient Domain Fusion</h1><p class="post-meta"> <time datetime="2016-10-11T02:47:36-07:00" itemprop="datePublished">Oct 11, 2016</time> <!-- <br>Read in about 4 minutes --></p></header><div class="post-content" itemprop="articleBody"><p>This post is a modified version of a site that I submitted for a project in my image manipulation class with <a href="https://scholar.google.com/citations?user=d97bGd8AAAAJ">Alexei Efros</a>.</p><p>On this page, I give some quick explanations of some algorithms, but the main focus is to display and compare results. The base technique is called Poisson Blending. Its goal is to blend a <em>source</em> image into a <em>target</em> image. It accomplishes this by defining constraints based on the <em>gradients</em> of the pixels in the result image. These constraints can be grouped to form a least-squares problem, which can be represented in sparse matrices and solved by a library least-squares solver.</p><h2 id="toy-problem-reconstruction">Toy Problem: Reconstruction</h2><p>To get used to formulating the pixel constraints as least squares problems in sparse matrices, first I practiced simply reconstructing an image given its gradient constraints and a single pixel intensity value.</p><p>In other words, if we are given a matrix values representing the gradients between neighboring pixel intensities:</p><p>and a single pixel intensity value, we should be able to reconstruct the original image by expanding intensity values out from the given pixel, using the gradients. The first image below is an example original, the second, the reconstructed version.</p><figure class="half"> <img src="/blog/assets/posts/gradient-domain-fusion/toy/toy_problem.png " /> <img src="/blog/assets/posts/gradient-domain-fusion/toy/reconstructed_toy.png " /><figcaption>sum(|1 - 2|): 0.0305</figcaption></figure><p>I was able to reduce the execution time of this reconstruction significantly (from around 15 seconds to around 4 seconds) by building the sparse constraint matrices via vectorization.</p><h2 id="poisson-blending">Poisson Blending</h2><p> One way to blend in image into another is with Poisson blending. There are two images: a source image, and a target image in which we want to place the source image. We create a mask that selects the portion of the source we want to blend into the target. Then, we set up the following constraints:<ul><li> Pixels in the target image that aren't in the masked area should be close to the intensity values in the target.</li><li> The gradients of pixels in the masked area should be constrained to have close to the gradients of those in the source image.</li></ul></p><figure> <img src="/blog/assets/posts/gradient-domain-fusion/equations/poisson.png " /><figcaption>v = result, t = target, s = source</figcaption></figure><p>Here are some results of Poisson blending:</p><h3 id="dirski">Dirski</h3><figure class="half"> <img src="/blog/assets/posts/gradient-domain-fusion/dirsky/dirsky.jpg " /></figure><p><br /></p><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/dirsky/dirks.jpg " /><figcaption>source</figcaption></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/dirsky/oski.jpg " /><figcaption>target</figcaption></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/dirsky/naive_dirsky.jpg " /><figcaption>naive overlay</figcaption></figure><h2 id="mixed-gradients">Mixed Gradients</h2><p>Mixed gradients is just like Poisson blending, except we constrain the gradients of the pixels in the masked area to be the gradient of those in the source image OR target image: whichever has a larger magnitude. Note that this gradient choice is made on a per-gradient basis.</p><figure> <img src="/blog/assets/posts/gradient-domain-fusion/equations/mixed.png " /><figcaption>d_ij is the value of the gradient from the source or the target image with a larger magnitude</figcaption></figure><h3 class="display"> SF Skyline<span> • Notice that the mixed gradients allow the tall buildings and the bridge to appear in front of the galaxy.</span></h3><figure class="full"> <img src="/blog/assets/posts/gradient-domain-fusion/skyline2/skyline3.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/skyline2/skyline.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/skyline2/galaxy.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/skyline2/polygon3.png " /></figure><h3 class="display"> Banksy on Brick<span> • The colors of the original piece are preserved, but toned to match the bricks. The brick texture also prevails because of its larger gradients.</span></h3><figure class="full"> <img src="/blog/assets/posts/gradient-domain-fusion/graffiti/graffiti.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/graffiti/bricks.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/graffiti/graffiti.png " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/graffiti/polygon.png " /></figure><h3 class="display"> That's No Moon<span> • The Death Star is faded to more match the brightness and color of the sky. Notice how the clouds float in front of the Death Star. Without mixed gradients, the clouds would simply fade out and become blurry when they got to the masked region. </span></h3><figure class="full"> <img src="/blog/assets/posts/gradient-domain-fusion/no_moon/no_moon_2_mixed.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/no_moon/campanile.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/no_moon/death_star.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/no_moon/polygon.png " /></figure><h3 class="display"> Just Dirksy Things<span> • Writing can be applied over images with mixed gradients. Notice how the pink background is completely disregarded because of its virtually zero gradient, while the words stand out due to the high gradient between the pink and letters. </span></h3><figure class="full"> <img src="/blog/assets/posts/gradient-domain-fusion/girly_things/dirsky_things.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/girly_things/dirks.jpg " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/girly_things/girly_things.png " /></figure><figure class="third"> <img src="/blog/assets/posts/gradient-domain-fusion/girly_things/polygon.png " /></figure><p><br /></p><h2 id="vs-laplacian-pyramid-blending">Vs. Laplacian Pyramid Blending</h2><p><a href="http://docs.opencv.org/3.1.0/dc/dff/tutorial_py_pyramids.html">Laplacian blending</a> is another cool way to blend images. Here’s a case when Poisson blending is clearly the way to go:</p><figure class="full"> <img src="/blog/assets/posts/gradient-domain-fusion/baby/sun_baby.jpg " /><figcaption>Poisson blending</figcaption></figure><figure class="half"> <img src="/blog/assets/posts/gradient-domain-fusion/baby/sun_baby_laplacian.jpg " /><figcaption>Laplacian pyramid blending</figcaption></figure><figure class="half"> <img src="/blog/assets/posts/gradient-domain-fusion/baby/naive_baby.jpg " /><figcaption>naive overlay</figcaption></figure><figure class="half"> <img src="/blog/assets/posts/gradient-domain-fusion/baby/baby.jpg " /><figcaption>source</figcaption></figure><figure class="half"> <img src="/blog/assets/posts/gradient-domain-fusion/baby/sun.jpg " /><figcaption>target</figcaption></figure><p>Poisson blending was much better than Laplacian blending in this case. This is because Poisson blending was able to make the overall color palette of the baby match that of the sun, which is the intended effect. Laplacian blending can’t and doesn’t achieve that effect. Laplacian blending can be better when Poisson blending would cause an unwanted color shift.</p><p>◼</p></div><div id="disqus_thread"></div><script> var disqus_config = function () { this.page.url = "http://steven.codes/blog/gradient-domain-fusion/"; this.page.identifier = "/gradient-domain-fusion/"; this.page.title = "Gradient Domain Fusion"; }; (function() { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = '//stevencodes.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></article></div><footer class="site-footer"><div class="wrapper"><h3 class="footer-heading"><a href="/blog/">steven.codes</a></h3><div class="footer-col-wrapper"><div class="footer-col footer-col-1"><ul class="contact-list"> <!--<li>Steven Traversi</li>--><li><a href="mailto:straversi@berkeley.edu">straversi@berkeley.edu</a></li><li> <a href="https://github.com/straversi"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg> </span><span class="username">straversi</span></a></li><li><a href="https://github.com/straversi/straversi.github.io/issues">See something wrong?</a></li></ul></div><div class="footer-col footer-col-2"><ul class="social-media-list"> <!--<li> <a href="https://twitter.com/StevenTraversi"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg> </span><span class="username">StevenTraversi</span></a></li>--></ul></div><div class="footer-col footer-col-3"><p>I post here about some of the things I'm working on.</p></div></div></div></footer></div></body></html>
