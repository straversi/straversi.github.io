<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Google Sheets DB Tutorial • steven.codes</title><meta name="description" content=" This article assumes a basic knowledge of JavaScript."><link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Bitter:400,700" rel="stylesheet"> <!--<link rel="stylesheet" href="/blog/css/main.css"> --><link rel="stylesheet" href="/blog/css/main.css?v=2.0"><link rel="canonical" href="http://steven.codes/blog/google-sheets-db-tutorial/"><link rel="alternate" type="application/rss+xml" title="steven.codes" href="http://steven.codes/blog/feed.xml"></head><body><div class="page-content"><header class="new-header"><div class="wrapper"> <a class="site-title" href="/blog/">steven.codes</a></div></header><div class="wrapper"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header class="post-header"><h1 class="post-title" itemprop="name headline">Google Sheets DB Tutorial</h1><p class="post-meta"> <time datetime="2016-02-06T01:47:36-08:00" itemprop="datePublished">Feb 6, 2016</time> <!-- <br>Read in about 5 minutes --></p></header><div class="post-content" itemprop="articleBody"><div class="notice"> This article assumes a basic knowledge of JavaScript.</div><p>The first part (the Google Sheets part) of this tutorial is first a restatement, then an extension, of <a href="https://mashe.hawksey.info/2014/07/google-sheets-as-a-database-insert-with-apps-script-using-postget-methods-with-ajax-example/">Martin Hawksey’s Google Sheets as a Database</a> article, with my own insights interjected. I include commentary from my experiences building <a href="/home">a “community” homepage</a> based on this idea. I’ve written this article to shed some light on what’s going on in Martin’s tutorial.</p><h2 id="the-google-sheets-part">The Google Sheets Part</h2><p>First, go to <a href="https://docs.google.com/spreadsheets/">Google Sheets</a>, and create a new sheet. Then in the menu, click <code>Tools &gt; Script editor...</code> to launch the IDE. For starters, let’s copy and paste Martin Hawksey’s Apps Script snippet into the editor. Here it is for convenience: <a href="https://gist.github.com/straversi/2fd82477504baa0b347c">gist</a></p><p>The first part of Martin’s tutorial tells you to run the function <code>setup</code>, reproduced here:</p><figure class="highlight"><figcaption>javascript</figcaption><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActiveSpreadsheet</span><span class="p">();</span>
    <span class="nx">SCRIPT_PROP</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">key</span><span class="dl">"</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getId</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure><p>It’d be nice to know what id does first! Line 1 of the function grabs what’s called the “Active Spreadsheet”, a.k.a. the spreadsheet that you opened this script editor through. (You may notice that when you try to close your spreadsheet tab, the script editor leaves along with it). So <code>doc</code> is an object representing your spreadsheet. When you don’t have the spreadsheet open, <code>getActiveSpreadsheet</code> will error. By setting a script property that we call “key”, we can remember the id of our spreadsheet so we can retrieve it whenever we want. Now that we know what’s going on… in the menu, select <code>Run &gt; setup</code>.</p><p>Google may tell you “Authorization required / This app needs authorization to run”. That’s fine, hit “Continue”. Your script needs access to (1) View and manage your spreadsheets and (2) View and manage data associated with the application. Allow both. Now <code>setup</code> has run, and if you’d like, select <code>File &gt; Project properties</code>, then select the <code>Script properties</code> tab. There’s the key that we just set! FYI, it’s the same id that appears at the end of the URL of your spreadsheet. So, we could have done this manually by inspecting the URL of our spreadsheet and entering the id in this <code>Script properties</code> tab. Either way, the script and the sheet are now together forever.</p><p>Time to deploy your script: select <code>Publish &gt; Deploy as web app...</code>. Choose to execute the app as yourself, and make sure to grant everyone access, like this:</p><p><img src="/blog/assets/posts/google-sheets-db-tutorial/deploy.png " /></p><p>Congrats. Save the “Current web app URL” that you are given, we’ll use it in a second. Don’t worry, you can recover it whenever you want by going back to <code>Publish &gt; Deploy as web app...</code>.</p><h3 id="in-action">In Action</h3><p>Let’s make something happen. Go to your Google Sheet, and add “Timestamp” to A1 and “Name” to B1; these will be our example headers. I’ve written two scripts, one jQuery and one plain JavaScript for you to play around with posting to the sheet. Take your pick, and try them out:</p><ul><li><a href="https://github.com/straversi/Google-sheet-interfaces/blob/master/JQuery-post.html">jQuery version</a></li><li><a href="https://github.com/straversi/Google-sheet-interfaces/blob/master/JavaScript-post.html">Vanilla JS version</a></li></ul><h2 id="updates-and-handling-gets">Updates, and Handling GETs</h2><p>Notice something? The current App Script code that we have attached to the spreadsheet doesn’t actually handle GETs in a useful way. Let’s fix that! We’ll divvy up <code>handleResponse</code> into two cases.</p><p>App Script gives us these reserved functions called <code>doGet</code> and <code>doPost</code>. When someone accesses our script with a GET or a POST, the appropriate function is called. We’ll define two new functions, <code>handleGet(e)</code> and <code>handlePost(e)</code> (or, feel free to place your response code inside <code>doGet</code> and <code>doPost</code> themselves).</p><p>First notice that our GET and POST will end up sharing some code: we need to keep these snippets from <code>handleResponse(e)</code> at the beginning and end of our new definitions:</p><figure class="highlight"><figcaption>javascript</figcaption><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">openById</span><span class="p">(</span><span class="nx">SCRIPT_PROP</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">key</span><span class="dl">"</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">sheet</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="nx">POST_SHEET_NAME</span><span class="p">);</span></code></pre></figure><figure class="highlight"><figcaption>javascript</figcaption><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">ContentService</span>
          <span class="p">.</span><span class="nx">createTextOutput</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">resultObject</span><span class="p">))</span>
          <span class="p">.</span><span class="nx">setMimeType</span><span class="p">(</span><span class="nx">ContentService</span><span class="p">.</span><span class="nx">MimeType</span><span class="p">.</span><span class="nx">JSON</span><span class="p">);</span></code></pre></figure><p>You may want to abstract those, as they’ll be the same for each type of response. In between, we’ll do our GET or POST work. I’ve modified the returned ContentService to return <code>resultObject</code>, which we can set to be whatever we want in both our GET and POST responses.</p><p><span class="important">Note:</span> If you separate your GET and POST handling, you should remember to move the <code>LockService</code> portions into your POST handler. We don’t want to be unnecessarily restricting read operations. Furthermore, App Script has changed since the script we began with was written. <code>LockService.getPublicLock</code> is now <code>LockService.getScriptLock</code>. Be sure to reflect this change in your code. For more on other types of locks, see <a href="https://developers.google.com/apps-script/reference/lock/lock-service">Class LockService</a>.</p><h2 id="safari-and-how-to-trick-it">Safari, And How to Trick It</h2><p>Our “database” operations should be successful so far. That is, except for this odd corner case: Safari.</p><p>What’s the problem? When we try to do our simple post, we get these errors in the console:</p><p><img src="/blog/assets/posts/google-sheets-db-tutorial/safari_http_errors.png " /></p><p>Aha, but if I check our spreadsheet database, I see that the <strong>POST still successfully got the correct data to the sheet!</strong> So it would seem that the problem here is that Safari can tell Google stuff, but Google can’t tell Safari stuff back. Which causes problems: (a) GETs are useless now, and (b) we can’t tell the difference between a successful and unsuccessful POST, because we can’t get our result key back.</p><h3 id="the-fix">The Fix</h3><p>To make a long story short, what we have here is a problem with <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross-Origin Resource Sharing</a> (CORS). Safari won’t accept Google’s response unless it has a certain header specifying <code>Access-Control-Allow-Origin: *</code>. This is a result of Safari adhering to W3C spec very closely. To fix this, we’ll have someone else make our requests for us. If we append <code>http://crossorigin.me/</code> to the beginning of our request URL (https://script.google.com/macros/s/AKfycb…), the folks over at crossorigin will make a nice request from a place that doesn’t care so much about CORS for us. We then receive the reply as Google sent it. ◼</p></div><div id="disqus_thread"></div><script> var disqus_config = function () { this.page.url = "http://steven.codes/blog/google-sheets-db-tutorial/"; this.page.identifier = "/google-sheets-db-tutorial/"; this.page.title = "Google Sheets DB Tutorial"; }; (function() { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = '//stevencodes.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></article></div><footer class="site-footer"><div class="wrapper"><h3 class="footer-heading"><a href="/blog/">steven.codes</a></h3><div class="footer-col-wrapper"><div class="footer-col footer-col-1"><ul class="contact-list"> <!--<li>Steven Traversi</li>--><li><a href="mailto:straversi@berkeley.edu">straversi@berkeley.edu</a></li><li> <a href="https://github.com/straversi"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg> </span><span class="username">straversi</span></a></li><li><a href="https://github.com/straversi/straversi.github.io/issues">See something wrong?</a></li></ul></div><div class="footer-col footer-col-2"><ul class="social-media-list"> <!--<li> <a href="https://twitter.com/StevenTraversi"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg> </span><span class="username">StevenTraversi</span></a></li>--></ul></div><div class="footer-col footer-col-3"><p>I post here about some of the things I'm working on.</p></div></div></div></footer></div></body></html>
